# Datadog Synthetic Tests for LMCX Carbon Credits
#
# This workflow triggers Datadog Synthetic tests if configured.
#
# Setup instructions:
# 1. Add DD_API_KEY and DD_APP_KEY as repository secrets
# 2. Configure Synthetic tests in Datadog with tag: e2e-tests
# See: https://docs.datadoghq.com/synthetics/cicd_integrations/github_actions/

name: Run Datadog Synthetic tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Check for Datadog secrets
      id: check-secrets
      run: |
        if [[ -z "${{ secrets.DD_API_KEY }}" || -z "${{ secrets.DD_APP_KEY }}" ]]; then
          echo "configured=false" >> $GITHUB_OUTPUT
          echo "::notice::Datadog secrets (DD_API_KEY, DD_APP_KEY) not configured. Skipping Synthetic tests."
        else
          echo "configured=true" >> $GITHUB_OUTPUT
        fi

    - uses: actions/checkout@v4
      if: steps.check-secrets.outputs.configured == 'true'

    - name: Run Datadog Synthetic tests
      if: steps.check-secrets.outputs.configured == 'true'
      uses: DataDog/synthetics-ci-github-action@v1.4.0
      with:
        api_key: ${{ secrets.DD_API_KEY }}
        app_key: ${{ secrets.DD_APP_KEY }}
        test_search_query: 'tag:e2e-tests'

    - name: Skip notice
      if: steps.check-secrets.outputs.configured == 'false'
      run: |
        echo "## Datadog Synthetic Tests Skipped" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Datadog API credentials are not configured." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "To enable Datadog Synthetic tests:" >> $GITHUB_STEP_SUMMARY
        echo "1. Add \`DD_API_KEY\` secret to repository" >> $GITHUB_STEP_SUMMARY
        echo "2. Add \`DD_APP_KEY\` secret to repository" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "See: https://docs.datadoghq.com/account_management/api-app-keys/" >> $GITHUB_STEP_SUMMARY
